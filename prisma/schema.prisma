// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== Enums =====

enum UserRole {
  admin
  player
}

// ===== Models =====

// Пользователь с паролем и уникальным именем
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  name      String   @unique // Имя пользователя (уникальное)
  password  String   // Простой пароль (не хешированный для удобства администратора)
  role      UserRole @default(player)
  
  sessions  Session[]
  achievements UserAchievement[]
  comments  Comment[]
  likes     CommentLike[]
  uploadedPhotos Photo[] @relation("UserUploadedPhotos")
  moderatedPhotos Photo[] @relation("UserModeratedPhotos")
}

// Фотография с датой из EXIF
model Photo {
  id           String    @id @default(cuid())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  storagePath  String    // путь в Supabase Storage
  originalName String?   // оригинальное название файла
  fileSize     Int?      // размер файла
  mimeType     String?   // тип файла
  width        Int?
  height       Int?
  isActive     Boolean   @default(true)
  
  // EXIF дата - это единственный вопрос в игре
  exifTakenAt  DateTime? // дата из EXIF (YYYY:MM:DD HH:mm:ss)
  exifRaw      Json?     // полные EXIF данные для админа
  
  // Спецвопрос (опционально)
  specialQuestion     String?  // Текст спецвопроса
  specialAnswerCorrect String? // Правильный ответ
  
  // Скрытое достижение за это фото (опционально)
  hiddenAchievementTitle       String? // Название достижения
  hiddenAchievementDescription String? // Описание достижения
  hiddenAchievementIcon        String? // Иконка (emoji)
  
  // Пользовательская загрузка и модерация
  uploadedBy      String?   // ID пользователя, который загрузил (null = админ)
  uploader        User?     @relation("UserUploadedPhotos", fields: [uploadedBy], references: [id], onDelete: SetNull)
  uploaderComment String?   // Комментарий от загрузчика о фото
  moderationStatus String   @default("approved") // pending, approved, rejected
  moderatedBy     String?   // ID админа, который модерировал
  moderator       User?     @relation("UserModeratedPhotos", fields: [moderatedBy], references: [id], onDelete: SetNull)
  moderatedAt     DateTime? // Когда была модерирована
  rejectionReason String?   // Причина отклонения (если rejected)
  
  sessionPhotos SessionPhoto[]
  comments      Comment[]
  
  @@index([uploadedBy])
  @@index([moderationStatus])
  @@index([moderatedBy])
}

// Игровая сессия - только рейтинговая
model Session {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now())
  finishedAt      DateTime? // null = в процессе, not null = завершена
  photoCount      Int       // количество фото в сессии
  totalScore      Int       @default(0) // итоговый счет
  currentPhotoIndex Int     @default(0) // текущее фото (0-based)
  durationSeconds Int?      // Длительность игры в секундах
  
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sessionPhotos   SessionPhoto[]
  
  @@index([userId])
  @@index([finishedAt]) // для лидерборда
}

// Связь сессии и фото
model SessionPhoto {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  
  sessionId  String
  session    Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  photoId    String
  photo      Photo    @relation(fields: [photoId], references: [id])
  
  orderIndex Int      // порядковый номер фото в сессии
  showSpecial Boolean @default(false) // Показывать ли спецвопрос для этого фото в этой игре
  
  guess      Guess?   // одна попытка на фото
  
  @@index([sessionId])
  @@index([photoId])
}

// Попытка угадать дату
model Guess {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  
  sessionPhotoId String  @unique
  sessionPhoto   SessionPhoto @relation(fields: [sessionPhotoId], references: [id], onDelete: Cascade)
  
  // Ответы пользователя
  guessedYear   Int?
  guessedMonth  Int?
  guessedDay    Int?
  guessedSpecial String? // Ответ на спецвопрос
  
  // Результаты
  yearHit       Boolean @default(false)  // год совпал
  monthHit      Boolean @default(false)  // месяц совпал
  dayHit        Boolean @default(false)  // день совпал
  specialHit    Boolean @default(false)  // спецвопрос совпал
  scoreDelta    Int     @default(0)      // очки за это фото
  timeSpentSec  Int?                     // время на ответ
  
  @@index([sessionPhotoId])
}

// Достижение (предустановленные)
model Achievement {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  key         String   @unique // Уникальный ключ (например: "yuri_gagarin")
  title       String   // Название (например: "Юрий Гагарин")
  description String   // Описание условия получения
  icon        String   // Иконка (emoji)
  category    String   // Категория (космос, аниме, игровые, и т.д.)
  isHidden    Boolean  @default(false) // Скрытое достижение (показывается только если получено)
  rarity      String   @default("common") // common, rare, epic, legendary
  
  users       UserAchievement[]
  
  @@index([key])
  @@index([category])
}

// Связь пользователя и достижения
model UserAchievement {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  // Для скрытых достижений (привязанных к фото)
  photoId       String?  // ID фото, за которое получено (для скрытых достижений)
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}

// Комментарий к фото
model Comment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  content   String   // Текст комментария
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  photoId   String
  photo     Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)
  
  likes     CommentLike[]
  
  @@index([userId])
  @@index([photoId])
  @@index([createdAt])
}

// Лайк комментария
model CommentLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  commentId String
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  @@unique([userId, commentId]) // Один пользователь может лайкнуть комментарий только один раз
  @@index([userId])
  @@index([commentId])
}
